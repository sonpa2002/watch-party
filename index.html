<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Watch Party Demo</title>
</head>
<body>
  <h3>Mode</h3>
  <label><input type="radio" name="mode" value="host" checked> Host</label>
  <label><input type="radio" name="mode" value="guest"> Guest</label>
  <p>Conn: <span id="state">...</span></p>

  <video id="vid" controls width="400" src="https://interactive-examples.mdn.mozilla.net/media/cc0-videos/flower.mp4"></video>

  <h3>Step 1: Local SDP</h3>
  <textarea id="local" style="width:100%;height:100px"></textarea><br>
  <button id="btnOffer">Tạo Offer</button>
  <button id="btnAnswer">Tạo Answer</button>

  <h3>Step 2: Remote SDP</h3>
  <textarea id="remote" style="width:100%;height:100px"></textarea><br>
  <button id="btnSetRemote">Set Remote</button>

<script>
const pc = new RTCPeerConnection({iceServers:[{urls:"stun:stun.l.google.com:19302"}]});
const state = document.getElementById("state");
const vid = document.getElementById("vid");

let dc; // datachannel
let applying = false;

pc.onconnectionstatechange = ()=> state.textContent = pc.connectionState;
pc.oniceconnectionstatechange = ()=> state.textContent = pc.iceConnectionState;

// Nếu là Host thì tạo channel
function ensureChannel(){
  if (!dc){
    dc = pc.createDataChannel("sync");
    hookDC();
  }
}
pc.ondatachannel = e => { dc = e.channel; hookDC(); };

function hookDC(){
  dc.onopen = ()=> console.log("DC open");
  dc.onmessage = e=>{
    const msg = JSON.parse(e.data);
    applying = true;
    if (msg.t=="play") { vid.currentTime=msg.time; vid.play(); }
    if (msg.t=="pause"){ vid.currentTime=msg.time; vid.pause(); }
    if (msg.t=="seek") { vid.currentTime=msg.time; }
    applying = false;
  };
}
function send(msg){ if (dc?.readyState==="open") dc.send(JSON.stringify(msg)); }

vid.addEventListener("play",()=>{ if(!applying) send({t:"play",time:vid.currentTime}); });
vid.addEventListener("pause",()=>{ if(!applying) send({t:"pause",time:vid.currentTime}); });
vid.addEventListener("seeked",()=>{ if(!applying) send({t:"seek",time:vid.currentTime}); });

const local = document.getElementById("local");
const remote = document.getElementById("remote");

btnOffer.onclick = async ()=>{
  ensureChannel();
  const offer = await pc.createOffer();
  await pc.setLocalDescription(offer);
  local.value = JSON.stringify(pc.localDescription);
};
btnAnswer.onclick = async ()=>{
  const answer = await pc.createAnswer();
  await pc.setLocalDescription(answer);
  local.value = JSON.stringify(pc.localDescription);
};
btnSetRemote.onclick = async ()=>{
  const desc = JSON.parse(remote.value);
  await pc.setRemoteDescription(desc);
};
</script>
</body>
</html>
