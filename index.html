<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Ở đây có thuyết minh — Watch Party</title>
  <link rel="stylesheet" href="https://cdn.plyr.io/3.7.8/plyr.css" />
  <style>
    body { background:#111; color:#fff; font-family:system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; }
    .container { max-width: 980px; margin: 16px auto; padding: 0 12px; }
    .topbar { display:flex; gap:16px; align-items:center; flex-wrap:wrap; margin-bottom:10px; }
    .pill { padding:6px 10px; border:1px solid #333; border-radius:999px; background:#191919; }
    .grid { display:grid; grid-template-columns: 1fr; gap:12px; }
    @media (min-width: 980px){ .grid{ grid-template-columns: 2fr 1fr; } }
    button { margin:4px; padding:6px 12px; border-radius:10px; border:1px solid #333; background:#1a1a1a; color:#fff; cursor:pointer; }
    button:hover { background:#222; }
    .FlashActive { background:#e67e22; border-color:#e67e22; }
    .MovieName { margin:12px 4px 6px; font-weight:700; opacity:.9; }
    .LoadingMovie { margin:8px 4px 12px; opacity:.8; }
    textarea { width:100%; min-height:120px; background:#0b0d12; color:#e5e7eb; border:1px solid #2a2f3a; border-radius:10px; padding:8px; }
    .card { background:#171a21; border:1px solid #222; border-radius:14px; padding:10px; }
    .status { font-size:12px; opacity:.8; }
    .row { display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
  </style>
</head>
<body>
  <div class="container">
    <div class="topbar">
      <span class="pill">Chế độ:</span>
      <label><input type="radio" name="mode" value="host" checked> Host</label>
      <label><input type="radio" name="mode" value="guest"> Guest</label>
      <span class="status">Kết nối: <span id="connState">chưa bắt đầu</span></span>
    </div>

    <div class="grid">
      <div>
        <div id="video-container">
          <video id="player" controls playsinline></video>
        </div>
        <div class="LoadingMovie" id="isLoad">Đang phát: Nhấn vào tập phim phía dưới để phát Video</div>
        
        <div class="MovieName">Cẩm Nguyệt Như Ca</div>
        <button data-src="https://vz-ad034ddb-54b.b-cdn.net/c0461509-86ce-4ba1-abb2-0be48eb35a4f/playlist.m3u8" data-sub="Track/CamNguyetNhuCa/Tap11.vtt" data-title="Cẩm Nguyệt Như Ca - Tập 11">Tập 11</button>
        <button data-src="https://vz-ad034ddb-54b.b-cdn.net/6305bd83-93e3-4266-990c-ab34c3596269/playlist.m3u8" data-sub="Track/CamNguyetNhuCa/Tap12.vtt" data-title="Cẩm Nguyệt Như Ca - Tập 12">Tập 12</button>
        <button data-src="https://vz-ad034ddb-54b.b-cdn.net/a6b8bbfc-77b1-4be7-b5c4-244e9a9735f1/playlist.m3u8" data-sub="Track/CamNguyetNhuCa/Tap13.vtt" data-title="Cẩm Nguyệt Như Ca - Tập 13">Tập 13</button>
        <button data-src="https://vz-ad034ddb-54b.b-cdn.net/9573d1d9-e970-4888-b9e9-93545364d5de/playlist.m3u8" data-sub="Track/CamNguyetNhuCa/Tap14.vtt" data-title="Cẩm Nguyệt Như Ca - Tập 14">Tập 14</button>
        <button data-src="https://vz-ad034ddb-54b.b-cdn.net/de706c52-45f7-4018-a38e-b24088943f02/playlist.m3u8" data-sub="Track/CamNguyetNhuCa/Tap15.vtt" data-title="Cẩm Nguyệt Như Ca - Tập 15">Tập 15</button>
        <button data-src="https://vz-ad034ddb-54b.b-cdn.net/638bb8e0-89a1-42e4-8b8f-c323bf52fd21/playlist.m3u8" data-sub="Track/CamNguyetNhuCa/Tap16.vtt" data-title="Cẩm Nguyệt Như Ca - Tập 16">Tập 16</button>
        <button data-src="https://vz-ad034ddb-54b.b-cdn.net/ac4d26e4-faad-4808-bacc-9aece38d6594/playlist.m3u8" data-sub="Track/CamNguyetNhuCa/Tap17.vtt" data-title="Cẩm Nguyệt Như Ca - Tập 17">Tập 17</button>
        <button data-src="https://vz-ad034ddb-54b.b-cdn.net/65a87074-6ce2-4be8-bc6c-412e36c78f1d/playlist.m3u8" data-sub="Track/CamNguyetNhuCa/Tap18.vtt" data-title="Cẩm Nguyệt Như Ca - Tập 18">Tập 18</button>
        <button data-src="https://vz-ad034ddb-54b.b-cdn.net/7bc7deb4-7f29-4141-83c1-3bf8952424b1/playlist.m3u8" data-sub="Track/CamNguyetNhuCa/Tap19.vtt" data-title="Cẩm Nguyệt Như Ca - Tập 19">Tập 19</button>
        <button data-src="https://vz-ad034ddb-54b.b-cdn.net/87b46749-9b55-410f-b550-26f9bafd6e84/playlist.m3u8" data-sub="Track/CamNguyetNhuCa/Tap20.vtt" data-title="Cẩm Nguyệt Như Ca - Tập 20">Tập 20</button>
        <button data-src="https://vz-ad034ddb-54b.b-cdn.net/247e135f-69fd-409c-88bc-64d88e18b481/playlist.m3u8" data-sub="Track/CamNguyetNhuCa/Tap21.vtt" data-title="Cẩm Nguyệt Như Ca - Tập 21">Tập 21</button>
        <button data-src="https://vz-aba01433-e5e.b-cdn.net/75295cdb-b6aa-4b7e-a58b-10c7bb924e31/playlist.m3u8" data-sub="Track/CamNguyetNhuCa/Tap22.vtt" data-title="Cẩm Nguyệt Như Ca - Tập 22">Tập 22</button>
        <button data-src="https://vz-aba01433-e5e.b-cdn.net/b28fa491-6f0d-42cf-abec-421963091114/playlist.m3u8" data-sub="Track/CamNguyetNhuCa/Tap23.vtt" data-title="Cẩm Nguyệt Như Ca - Tập 23">Tập 23</button>
        <button data-src="https://vz-aba01433-e5e.b-cdn.net/b2975423-25a0-4381-bf08-45ef5327b932/playlist.m3u8" data-sub="Track/CamNguyetNhuCa/Tap24.vtt" data-title="Cẩm Nguyệt Như Ca - Tập 24">Tập 24</button>
        <button data-src="https://vz-aba01433-e5e.b-cdn.net/2f07fa28-29c4-4ae1-b4ed-27a5b5556435/playlist.m3u8" data-sub="Track/CamNguyetNhuCa/Tap25.vtt" data-title="Cẩm Nguyệt Như Ca - Tập 25">Tập 25</button>
        <button data-src="https://vz-aba01433-e5e.b-cdn.net/2ac1ad0e-fb03-43ee-a401-98b1f476975f/playlist.m3u8" data-sub="Track/CamNguyetNhuCa/Tap26.vtt" data-title="Cẩm Nguyệt Như Ca - Tập 26">Tập 26</button>
        <button data-src="" data-sub="Track/CamNguyetNhuCa/Tap27.vtt" data-title="Cẩm Nguyệt Như Ca - Tập 27">Tập 27</button>
        <button data-src="" data-sub="Track/CamNguyetNhuCa/Tap28.vtt" data-title="Cẩm Nguyệt Như Ca - Tập 28">Tập 28</button>
        <button data-src="" data-sub="Track/CamNguyetNhuCa/Tap29.vtt" data-title="Cẩm Nguyệt Như Ca - Tập 29">Tập 29</button>
        <button data-src="" data-sub="Track/CamNguyetNhuCa/Tap30.vtt" data-title="Cẩm Nguyệt Như Ca - Tập 30">Tập 30</button>
        <button data-src="" data-sub="Track/CamNguyetNhuCa/Tap31.vtt" data-title="Cẩm Nguyệt Như Ca - Tập 31">Tập 31</button>
        <button data-src="" data-sub="Track/CamNguyetNhuCa/Tap32.vtt" data-title="Cẩm Nguyệt Như Ca - Tập 32">Tập 32</button>
        <button data-src="" data-sub="Track/CamNguyetNhuCa/Tap33.vtt" data-title="Cẩm Nguyệt Như Ca - Tập 33">Tập 33</button>
        <button data-src="" data-sub="Track/CamNguyetNhuCa/Tap34.vtt" data-title="Cẩm Nguyệt Như Ca - Tập 34">Tập 34</button>
        <button data-src="" data-sub="Track/CamNguyetNhuCa/Tap35.vtt" data-title="Cẩm Nguyệt Như Ca - Tập 35">Tập 35</button>
        <button data-src="" data-sub="Track/CamNguyetNhuCa/Tap36.vtt" data-title="Cẩm Nguyệt Như Ca - Tập 36">Tập 36</button>
        
      </div>

      <div>
        <div class="card">
          <h3>Kết nối P2P (không server)</h3>
          <div class="row">
            <button id="btnCreateLocal">1) Tạo Offer (Host)</button>
            <button id="btnCopyLocal">Copy</button>
          </div>
          <textarea id="localSdp" placeholder="Offer/Answer của bạn sẽ xuất hiện ở đây"></textarea>
          <div class="row" style="margin-top:8px">
            <button id="btnSetRemote">2) Set Remote</button>
            <button id="btnMakeAnswer">3) Tạo Answer (Guest)</button>
          </div>
          <textarea id="remoteSdp" placeholder="Dán Offer/Answer người kia vào đây"></textarea>
          <div class="row">
            <button id="btnStartVoice">Bật Voice Chat</button>
            <button id="btnStopVoice">Tắt Voice Chat</button>
          </div>
          <p class="status">
            • Host: bấm (1) → copy → gửi cho Guest. Sau đó paste Answer của Guest → (2).<br>
            • Guest: paste Offer của Host → (2) → bấm (3) → copy Answer trả Host.
          </p>
        </div>
      </div>
    </div>
  </div>

  <!-- Plyr + HLS.js -->
  <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
  <script src="https://cdn.plyr.io/3.7.8/plyr.polyfilled.js"></script>
  <script>
    const titleDisplay = document.getElementById('isLoad');
    const buttons = document.querySelectorAll('button[data-src]');
    const videoContainer = document.getElementById('video-container');
    let hls, player, TileVideo;

    function CaptionsChange(){
      const videoTagInfo = document.getElementById("player");
      const rect = videoTagInfo.getBoundingClientRect();
      const captions = document.querySelector('.plyr__captions');
      if (captions) {
        captions.style.setProperty('bottom', `calc(50% - ${(rect.width/TileVideo)/2.42}px)`, 'important');
        captions.style.setProperty('font-size', `${rect.width/36}px`, 'important');
        captions.style.setProperty('line-height', `${rect.width/32}px`, 'important');
      }
    }

    function playVideo(src, title, subSrc) {
      if (hls) hls.destroy();
      if (player) player.destroy();

      const subtitleTrack = subSrc ? `<track kind="subtitles" label="Tiếng Việt" srclang="vi" src="${subSrc}">` : '';
      videoContainer.innerHTML = `<video id="player" controls playsinline>${subtitleTrack}</video>`;
      const el = document.getElementById('player');

      hls = new Hls();
      hls.loadSource(src);
      hls.attachMedia(el);
      hls.on(Hls.Events.MANIFEST_PARSED, (event, data) => {
        const availableQualities = data.levels.map((level, index) => ({ label: `${level.height}p`, value: index })).reverse();
        availableQualities.unshift({ label: 'Auto', value: -1 });

        player = new Plyr(el, {
          controls: ['play-large','rewind','play','fast-forward','progress','current-time','duration','mute','volume','captions','settings','fullscreen'],
          quality: { default: -1, options: availableQualities.map(q => q.value), forced: true, onChange: (newQuality) => { hls.currentLevel = newQuality; } },
          i18n: { qualityLabel: { '-1': 'Auto', ...Object.fromEntries(availableQualities.map(q => [q.value, q.label])) } },
          captions: { active: true, update: true }
        });

        const btnCap = document.querySelector('button.plyr__control[data-plyr="captions"]');
        if (btnCap && btnCap.getAttribute('aria-pressed') === 'false') btnCap.click();

        TileVideo = data.levels[0].width / data.levels[0].height;
        CaptionsChange();
        hookPlayerSyncEvents();
        player.play();
      });

      titleDisplay.textContent = `Đang phát: ${title}`;
    }

    window.addEventListener("resize", CaptionsChange);

    // ---------- WebRTC P2P ----------
    const connStateEl = document.getElementById('connState');
    const setConnState = (t)=> connStateEl.textContent = t;
    let pc, dc;
    let isRemoteApplying = false;
    let lastHeartbeat = 0;
    const mode = () => document.querySelector('input[name="mode"]:checked').value;

    let localStream = null;
    let remoteAudioEl = null;

    function newPeer(){
      if (pc) { try{pc.close()}catch{} }
      pc = new RTCPeerConnection({ iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] });
      pc.oniceconnectionstatechange = ()=> setConnState(pc.iceConnectionState);
      pc.onconnectionstatechange = ()=> setConnState(pc.connectionState);
      pc.ondatachannel = (e)=> { dc = e.channel; setupDC(); };
      if (mode()==='host'){ dc = pc.createDataChannel('sync'); setupDC(); }
      pc.ontrack = (event) => {
        if (!remoteAudioEl) {
          remoteAudioEl = document.createElement('audio');
          remoteAudioEl.autoplay = true;
          remoteAudioEl.style.display = 'none';
          document.body.appendChild(remoteAudioEl);
        }
        remoteAudioEl.srcObject = event.streams[0];
      };
    }
    newPeer();

    document.querySelectorAll('input[name="mode"]').forEach(r=>{
      r.addEventListener('change', ()=>{ newPeer(); });
    });

    function setupDC(){
      if (!dc) return;
      dc.onopen = ()=> { if (dc.readyState==='open') sendState(); };
      dc.onmessage = (e)=>{ try { handleMsg(JSON.parse(e.data)); } catch {} };
    }

    function send(obj){
      if (dc && dc.readyState==='open'){ dc.send(JSON.stringify(obj)); }
    }

    async function waitIceComplete(){
      if (pc.iceGatheringState === 'complete') return;
      await new Promise(resolve=>{
        const to = setTimeout(resolve, 2000);
        pc.addEventListener('icegatheringstatechange', function onchg(){
          if (pc.iceGatheringState === 'complete'){
            pc.removeEventListener('icegatheringstatechange', onchg);
            clearTimeout(to);
            resolve();
          }
        });
      });
    }

    // ---- Sync video events ----
    function broadcastLoad(src, title, sub){
      send({ t:'load', src, title, sub });
      setTimeout(()=> sendState(), 350);
    }

    function sendState(){
      if (!player) return;
      send({ t:'state', paused: player.paused, time: player.currentTime });
    }

    function hookPlayerSyncEvents(){
      if (!player || player.__hooked) return;
      player.__hooked = true;
      player.on('play', ()=> { if (!isRemoteApplying) send({ t:'play', time: player.currentTime }); });
      player.on('pause', ()=> { if (!isRemoteApplying) send({ t:'pause', time: player.currentTime }); });
      player.on('seeked', ()=> { if (!isRemoteApplying) send({ t:'seek', time: player.currentTime }); });
      player.on('timeupdate', ()=>{
        const now = Date.now();
        if (now - lastHeartbeat > 60000) {
          lastHeartbeat = now;
          if (!isRemoteApplying) send({ t:'tick', time: player.currentTime, paused: player.paused });
        }
      });
    }

    function softSeek(target){
      if (!player || typeof target !== 'number') return;
      const drift = Math.abs(player.currentTime - target);
      if (drift > 1) player.currentTime = target;
    }

    function handleMsg(msg){
      if (msg.t === 'load'){
        const currentTrack = document.querySelector('#player track')?.getAttribute('src') || '';
        if (msg.src){
          const sameSrc = !!hls && hls.url && hls.url === msg.src;
          if (!sameSrc || currentTrack !== (msg.sub || '')) {
            playVideo(msg.src, msg.title || '', msg.sub || '');
          }
        }
        return;
      }
      if (!player) return;

      isRemoteApplying = true;
      try {
        if (msg.t === 'play'){ softSeek(msg.time); player.play(); }
        else if (msg.t === 'pause'){ softSeek(msg.time); player.pause(); }
        else if (msg.t === 'seek'){ softSeek(msg.time); }
        else if (msg.t === 'state'){
          if (msg.paused) { softSeek(msg.time); player.pause(); }
          else { softSeek(msg.time); player.play(); }
        }
        else if (msg.t === 'tick'){
          softSeek(msg.time);
          if (msg.paused && !player.paused) player.pause();
          if (!msg.paused && player.paused) player.play();
        }
      } finally { isRemoteApplying = false; }
    }

    // ---- Chọn tập ----
    buttons.forEach(button => {
      button.addEventListener('click', () => {
        const src = button.getAttribute('data-src');
        const title = button.getAttribute('data-title');
        const sub = button.getAttribute('data-sub');
        if (!src){
          alert('Video chưa được cập nhật!');
          return;
        }
        buttons.forEach(btn => btn.classList.remove('FlashActive'));
        button.classList.add('FlashActive');
        playVideo(src, title, sub);
        if (mode()==='host') broadcastLoad(src, title, sub);
      });
    });

    // ---- Signaling ----
    const $ = (id)=> document.getElementById(id);
    const localSdp = $('localSdp');
    const remoteSdp = $('remoteSdp');

    $('btnCreateLocal').onclick = async ()=>{
      if (mode() !== 'host') { alert('Nút này dành cho Host.'); return; }
      const offer = await pc.createOffer();
      await pc.setLocalDescription(offer);
      await waitIceComplete();
      localSdp.value = JSON.stringify(pc.localDescription);
    };

    $('btnSetRemote').onclick = async ()=>{
      const desc = tryParse(remoteSdp.value);
      if (!desc) return alert('JSON không hợp lệ');
      if (desc.type === 'offer'){
        await pc.setRemoteDescription(desc);
        const answer = await pc.createAnswer();
        await pc.setLocalDescription(answer);
        await waitIceComplete();
        localSdp.value = JSON.stringify(pc.localDescription);
        return;
      }
      if (desc.type === 'answer'){
        await pc.setRemoteDescription(desc);
        return;
      }
      alert('SDP type không hợp lệ: ' + desc.type);
    };

    $('btnMakeAnswer').onclick = async ()=>{
      if (mode() !== 'guest') { alert('Nút này dành cho Guest.'); return; }
      if (!pc.remoteDescription || pc.remoteDescription.type !== 'offer'){
        alert('Hãy dán Offer của Host và bấm "Set Remote" trước.');
        return;
      }
      const answer = await pc.createAnswer();
      await pc.setLocalDescription(answer);
      await waitIceComplete();
      localSdp.value = JSON.stringify(pc.localDescription);
    };

    $('btnCopyLocal').onclick = ()=> navigator.clipboard.writeText(localSdp.value || '');

    function tryParse(s){ try{ return JSON.parse(s) }catch{ return null } }

    // ---- Voice Chat ----
    $('btnStartVoice').onclick = async ()=>{
      if (!pc) return alert('Chưa có PeerConnection');
      try {
        localStream = await navigator.mediaDevices.getUserMedia({ audio: true });
        localStream.getTracks().forEach(track => pc.addTrack(track, localStream));
        alert('Voice Chat đã bật');
      } catch (err) { alert('Không thể bật micro: '+err.message); }
    };
    $('btnStopVoice').onclick = ()=>{
      if (localStream) {
        localStream.getTracks().forEach(track=>track.stop());
        localStream=null;
      }
      alert('Voice Chat đã tắt');
    };
  </script>
</body>
</html>
