<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Watch Party Demo ‚Äì Pure Frontend (Plyr + HLS + WebRTC)</title>
  <link rel="stylesheet" href="https://cdn.plyr.io/3.7.8/plyr.css" />
  <style>
    :root { --bg:#0f1115; --panel:#171a21; --accent:#38bdf8; --text:#e5e7eb; }
    body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;}
    .wrap{max-width:1000px;margin:20px auto;padding:16px}
    h1{font-size:20px;margin:0 0 12px}
    .grid{display:grid;grid-template-columns:1fr;gap:12px}
    @media(min-width:900px){.grid{grid-template-columns: 2fr 1fr}}
    .card{background:var(--panel);border-radius:14px;padding:12px;border:1px solid #222}
    .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    label{font-size:12px;opacity:.85}
    input,textarea,select,button{background:#0b0d12;color:var(--text);border:1px solid #2a2f3a;border-radius:10px;padding:8px 10px;font-size:14px}
    textarea{width:100%;min-height:110px;resize:vertical}
    button{cursor:pointer}
    button.primary{background:var(--accent);color:#001018;border:none}
    .pill{padding:6px 10px;border-radius:999px;background:#0b0d12;border:1px solid #283041}
    .status{font-size:12px;opacity:.8}
    .muted{opacity:.7}
    .btns{display:flex;gap:8px;flex-wrap:wrap;margin-top:6px}
    .small{font-size:12px;padding:6px 8px;border-radius:8px}
    #log{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; font-size:12px; white-space:pre-wrap; max-height:200px; overflow:auto; background:#0b0d12; padding:8px; border-radius:10px; border:1px solid #2a2f3a}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Watch Party Demo ‚Äì Kh√¥ng c·∫ßn backend (P2P WebRTC + DataChannel + Voice)</h1>
    <div class="grid">
      <div class="card">
        <div class="row" style="justify-content:space-between">
          <div class="row">
            <span class="pill">Vai tr√≤:</span>
            <select id="role">
              <option value="host">Host (t·∫°o ph√≤ng)</option>
              <option value="guest">Guest (tham gia)</option>
            </select>
          </div>
          <div class="status">K·∫øt n·ªëi: <span id="connState">ch∆∞a b·∫Øt ƒë·∫ßu</span></div>
        </div>

        <div class="row" style="margin-top:8px">
          <label>URL HLS (m3u8):</label>
          <input id="src" style="flex:1" placeholder="https://.../playlist.m3u8" value="https://test-streams.mux.dev/x36xhzz/x36xhzz.m3u8"/>
          <button id="loadSrc" class="small">T·∫£i ngu·ªìn</button>
        </div>

        <div style="margin-top:10px">
          <video id="player" playsinline controls></video>
        </div>

        <div class="btns">
          <button id="btnMic" class="small">üéôÔ∏è B·∫≠t micro</button>
          <button id="btnMuteRemote" class="small">üîá T·∫Øt ti·∫øng ng∆∞·ªùi kia</button>
          <button id="btnResync" class="small">üîÅ ƒê·ªìng b·ªô l·∫°i</button>
        </div>
      </div>

      <div class="card">
        <div class="row"><span class="pill">B∆∞·ªõc 1</span><span class="muted">T·∫°o/chia s·∫ª Offer ‚Äì ho·∫∑c d√°n Offer ƒë·ªÉ t·∫°o Answer</span></div>
        <textarea id="localSdp" placeholder="Offer/Answer c·ªßa b·∫°n s·∫Ω xu·∫•t hi·ªán ·ªü ƒë√¢y"></textarea>
        <div class="btns">
          <button id="btnCreateOffer" class="primary small">T·∫°o Offer (Host)</button>
          <button id="btnCreateAnswer" class="small">T·∫°o Answer (Guest)</button>
          <button id="btnCopyLocal" class="small">Copy c·ªßa t√¥i</button>
        </div>
        <div class="row" style="margin-top:12px"><span class="pill">B∆∞·ªõc 2</span><span class="muted">D√°n Offer/Answer t·ª´ ph√≠a c√≤n l·∫°i</span></div>
        <textarea id="remoteSdp" placeholder="D√°n Offer/Answer nh·∫≠n t·ª´ ng∆∞·ªùi kia ·ªü ƒë√¢y"></textarea>
        <div class="btns">
          <button id="btnSetRemote" class="small">Set Remote</button>
        </div>
        <div style="margin-top:12px">
          <div class="row"><span class="pill">Nh·∫≠t k√Ω</span></div>
          <div id="log"></div>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
  <script src="https://cdn.plyr.io/3.7.8/plyr.polyfilled.js"></script>
  <script>
    // ==== UI helpers ====
    const $ = (sel)=>document.querySelector(sel);
    const log = (...args)=>{ const s=args.map(a=>typeof a==='string'?a:JSON.stringify(a)).join(' '); const el=$('#log'); el.textContent += s+"\n"; el.scrollTop=el.scrollHeight; console.log(...args) };
    const setConnState = (t)=> $('#connState').textContent = t;

    // ==== Plyr + HLS setup ====
    let hls, plyr, playerEl = $('#player');
    function loadVideo(src){
      if (hls){ hls.destroy(); hls=null }
      if (!Hls.isSupported()){
        // Safari h·ªó tr·ª£ native HLS
        playerEl.src = src;
        if (!plyr) plyr = new Plyr(playerEl, {captions: {active: true}, quality: {forced:true}});
        else plyr.source = { type:'video', sources:[{src, type:'application/x-mpegURL'}] };
      } else {
        hls = new Hls();
        hls.loadSource(src);
        hls.attachMedia(playerEl);
        if (!plyr) plyr = new Plyr(playerEl, {captions: {active: true}});
      }
      log('ƒê√£ t·∫£i ngu·ªìn:', src);
    }
    $('#loadSrc').onclick = ()=> loadVideo($('#src').value.trim());
    // t·∫£i s·∫µn demo stream
    loadVideo($('#src').value.trim());

    // ==== WebRTC P2P (kh√¥ng backend) ====
    const pc = new RTCPeerConnection({
      iceServers: [
        { urls: "stun:stun.l.google.com:19302" }
      ]
    });


    let dataChannel;           // ƒë·ªìng b·ªô play/pause/seek
    let localStream;           // micro
    let remoteAudioEl;         // ph√°t ti·∫øng ng∆∞·ªùi kia
    let isApplyingRemote = false; // tr√°nh v√≤ng l·∫∑p s·ª± ki·ªán
    let lastSyncSentAt = 0;

    pc.oniceconnectionstatechange = ()=> setConnState(pc.iceConnectionState);
    pc.onconnectionstatechange = ()=> setConnState(pc.connectionState);

    // Nh·∫≠n track (ti·∫øng c·ªßa ng∆∞·ªùi kia)
    pc.ontrack = (e)=>{
      if (!remoteAudioEl){
        remoteAudioEl = document.createElement('audio');
        remoteAudioEl.autoplay = true; remoteAudioEl.controls = false; remoteAudioEl.style.display='none';
        document.body.appendChild(remoteAudioEl);
      }
      remoteAudioEl.srcObject = e.streams[0];
      log('ƒê√£ nh·∫≠n audio remote');
    };

    // N·∫øu b√™n kia t·∫°o data channel tr∆∞·ªõc
    pc.ondatachannel = (evt)=>{
      dataChannel = evt.channel;
      setupDataChannel();
    };

    // T·∫°o data channel n·∫øu l√† Host
    function ensureDataChannel(){
      if (!dataChannel){
        dataChannel = pc.createDataChannel('sync');
        setupDataChannel();
      }
    }

    function setupDataChannel(){
      dataChannel.onopen = ()=>{ log('DataChannel m·ªü'); sendHelloAndState(); };
      dataChannel.onmessage = (e)=>{
        try{ const msg = JSON.parse(e.data); handleMsg(msg); }
        catch(err){ log('Msg kh√¥ng h·ª£p l·ªá:', e.data) }
      };
      dataChannel.onerror = (e)=> log('DataChannel error', e);
    }

    // L·∫•y micro
    async function toggleMic(){
      if (!localStream){
        try{
          localStream = await navigator.mediaDevices.getUserMedia({ audio: true });
          localStream.getTracks().forEach(t=> pc.addTrack(t, localStream));
          $('#btnMic').textContent = 'üéôÔ∏è T·∫Øt micro';
          log('Micro ƒë√£ b·∫≠t');
        }catch(err){ log('Kh√¥ng truy c·∫≠p ƒë∆∞·ª£c micro:', err.message) }
      }else{
        localStream.getTracks().forEach(t=> t.stop());
        localStream = null;
        $('#btnMic').textContent = 'üéôÔ∏è B·∫≠t micro';
        log('Micro ƒë√£ t·∫Øt');
      }
    }

    $('#btnMic').onclick = toggleMic;
    $('#btnMuteRemote').onclick = ()=>{ if (remoteAudioEl){ remoteAudioEl.muted = !remoteAudioEl.muted; log('Remote muted =', remoteAudioEl.muted) } };

    // ==== Signaling th·ªß c√¥ng (copy/paste) ====
    async function createOffer(){
      ensureDataChannel();
      const offer = await pc.createOffer();
      await pc.setLocalDescription(offer);
      $('#localSdp').value = JSON.stringify(pc.localDescription);
      log('Offer ƒë√£ t·∫°o ‚Äì copy g·ª≠i cho ng∆∞·ªùi kia');
    }

    async function createAnswer(){
      const remote = parseJSON($('#remoteSdp').value);
      if (!remote) return;
      await pc.setRemoteDescription(remote);
      const answer = await pc.createAnswer();
      await pc.setLocalDescription(answer);
      $('#localSdp').value = JSON.stringify(pc.localDescription);
      log('Answer ƒë√£ t·∫°o ‚Äì copy g·ª≠i l·∫°i Host');
    }

    async function setRemote(){
      const desc = parseJSON($('#remoteSdp').value);
      if (!desc) return;
      await pc.setRemoteDescription(desc);
      log('ƒê√£ set remote description');
    }

    function parseJSON(s){ try{ return JSON.parse(s) }catch{ alert('JSON kh√¥ng h·ª£p l·ªá'); return null } }

    $('#btnCreateOffer').onclick = createOffer;
    $('#btnCreateAnswer').onclick = createAnswer;
    $('#btnSetRemote').onclick = setRemote;
    $('#btnCopyLocal').onclick = ()=>{ navigator.clipboard.writeText($('#localSdp').value); log('ƒê√£ copy c·ªßa b·∫°n v√†o clipboard') };

    // ==== ƒê·ªìng b·ªô video qua DataChannel ====
    function send(msg){ if (dataChannel && dataChannel.readyState==='open'){ dataChannel.send(JSON.stringify(msg)) } }

    // G·ª≠i tr·∫°ng th√°i hi·ªán t·∫°i cho ng∆∞·ªùi m·ªõi v√†o (src + paused + time)
    function sendHelloAndState(){
      const src = $('#src').value.trim();
      send({type:'hello'});
      send({type:'load', src});
      sendState();
    }

    function sendState(){
      if (!plyr) return;
      send({type:'state', paused: plyr.paused, time: plyr.currentTime});
    }

    $('#btnResync').onclick = sendState;

    // L·∫Øng nghe s·ª± ki·ªán t·ª´ Plyr (ch·ªâ g·ª≠i khi l√† thao t√°c local)
    function hookPlayerEvents(){
      if (!plyr) return;
      plyr.on('play', ()=> send({type:'play', time: plyr.currentTime}));
      plyr.on('pause', ()=> send({type:'pause', time: plyr.currentTime}));
      plyr.on('seeked', ()=> send({type:'seek', time: plyr.currentTime}));
      // g·ª≠i nh·ªãp tim ƒë·ªìng b·ªô nh·∫π m·ªói 3s
      plyr.on('timeupdate', ()=>{
        const now = Date.now();
        if (now - lastSyncSentAt > 3000){
          lastSyncSentAt = now;
          send({type:'tick', time: plyr.currentTime, paused: plyr.paused});
        }
      });
    }

    function applyRemote(action){
      if (!plyr) return;
      isApplyingRemote = true;
      try{
        if (action.type==='load' && action.src){
          if ($('#src').value.trim() !== action.src){
            $('#src').value = action.src; loadVideo(action.src);
          }
        }
        if (action.type==='play' || (action.type==='state' && action.paused===false)){
          softSeek(action.time);
          plyr.play();
        }
        if (action.type==='pause' || (action.type==='state' && action.paused===true)){
          softSeek(action.time);
          plyr.pause();
        }
        if (action.type==='seek' || action.type==='tick'){
          softSeek(action.time);
        }
      } finally{ isApplyingRemote = false }
    }

    function softSeek(t){
      if (typeof t !== 'number') return;
      const drift = Math.abs((plyr?.currentTime||0) - t);
      if (drift > 0.5){ plyr.currentTime = t }
    }

    function handleMsg(msg){
      if (msg.type==='hello'){ log('Peer ch√†o'); return }
      applyRemote(msg);
    }

    // Kh·ªüi t·∫°o hook sau khi Plyr s·∫µn s√†ng
    const waitPlyr = setInterval(()=>{ if (plyr){ clearInterval(waitPlyr); hookPlayerEvents(); } }, 200);

    // G·ª£i √Ω thao t√°c nhanh theo vai tr√≤
    $('#role').addEventListener('change', ()=>{
      const r = $('#role').value;
      if (r==='host'){
        log('B·∫°n l√† Host: 1) T·∫£i URL HLS 2) B·∫•m T·∫°o Offer 3) G·ª≠i cho Guest 4) Paste Answer c·ªßa Guest v√† Set Remote');
      } else {
        log('B·∫°n l√† Guest: 1) Nh·∫≠n Offer t·ª´ Host, d√°n v√†o Remote 2) B·∫•m T·∫°o Answer 3) G·ª≠i Answer l·∫°i cho Host 4) Host Set Remote -> k·∫øt n·ªëi xong');
      }
    });
    $('#role').dispatchEvent(new Event('change'));
  </script>
</body>
</html>
